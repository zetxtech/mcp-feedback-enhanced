name: Build Desktop Applications

on:
  workflow_dispatch:  # æ‰‹å‹•è§¸ç™¼
    inputs:
      platforms:
        description: 'é¸æ“‡è¦æ§‹å»ºçš„å¹³å°'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - windows
        - macos
        - linux
      upload_artifacts:
        description: 'æ˜¯å¦ä¸Šå‚³æ§‹å»ºç”¢ç‰©'
        required: true
        default: true
        type: boolean

  push:
    paths:
      - 'src-tauri/**'  # æ¡Œé¢æ‡‰ç”¨ä»£ç¢¼è®Šæ›´æ™‚è‡ªå‹•è§¸ç™¼
      - 'scripts/build_desktop.py'
    branches:
      - main

  pull_request:
    paths:
      - 'src-tauri/**'
      - 'scripts/build_desktop.py'

env:
  CARGO_TERM_COLOR: always

jobs:
  # å¤šå¹³å°æ¡Œé¢æ‡‰ç”¨æ§‹å»º
  build-desktop:
    strategy:
      fail-fast: false  # å…è¨±éƒ¨åˆ†å¹³å°å¤±æ•—
      matrix:
        include:
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            binary: mcp-feedback-enhanced-desktop.exe
            name: windows
            enabled: ${{ github.event.inputs.platforms == 'all' || github.event.inputs.platforms == 'windows' || github.event.inputs.platforms == '' }}
          - os: macos-latest
            target: x86_64-apple-darwin
            binary: mcp-feedback-enhanced-desktop
            name: macos-intel
            enabled: ${{ github.event.inputs.platforms == 'all' || github.event.inputs.platforms == 'macos' || github.event.inputs.platforms == '' }}
          - os: macos-latest
            target: aarch64-apple-darwin
            binary: mcp-feedback-enhanced-desktop
            name: macos-arm64
            enabled: ${{ github.event.inputs.platforms == 'all' || github.event.inputs.platforms == 'macos' || github.event.inputs.platforms == '' }}
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            binary: mcp-feedback-enhanced-desktop
            name: linux
            enabled: ${{ github.event.inputs.platforms == 'all' || github.event.inputs.platforms == 'linux' || github.event.inputs.platforms == '' }}

    runs-on: ${{ matrix.os }}
    if: ${{ matrix.enabled != 'false' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}

    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"

    - name: Set up Python
      run: uv python install

    - name: Install dependencies
      run: uv sync --dev

    - name: Cache Rust dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          src-tauri/target
        key: ${{ runner.os }}-cargo-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-${{ matrix.target }}-
          ${{ runner.os }}-cargo-

    - name: Build desktop application for ${{ matrix.name }}
      run: |
        cd src-tauri
        cargo build --release --target ${{ matrix.target }} --bin mcp-feedback-enhanced-desktop

    - name: Verify build output
      run: |
        echo "ðŸ” æª¢æŸ¥æ§‹å»ºç”¢ç‰©..."
        if [ "${{ matrix.os }}" = "windows-latest" ]; then
          ls -la "src-tauri/target/${{ matrix.target }}/release/${{ matrix.binary }}" || echo "âŒ Windows äºŒé€²åˆ¶æ–‡ä»¶ä¸å­˜åœ¨"
        else
          ls -la "src-tauri/target/${{ matrix.target }}/release/${{ matrix.binary }}" || echo "âŒ ${{ matrix.name }} äºŒé€²åˆ¶æ–‡ä»¶ä¸å­˜åœ¨"
        fi
      shell: bash

    - name: Upload desktop binary
      if: ${{ github.event.inputs.upload_artifacts != 'false' }}
      uses: actions/upload-artifact@v4
      with:
        name: desktop-${{ matrix.name }}
        path: src-tauri/target/${{ matrix.target }}/release/${{ matrix.binary }}
        retention-days: 30  # ä¿ç•™ 30 å¤©
        compression-level: 6

  # æ§‹å»ºæ‘˜è¦
  build-summary:
    needs: build-desktop
    runs-on: ubuntu-latest
    if: always()

    steps:
    - name: Generate build summary
      run: |
        echo "## ðŸ–¥ï¸ æ¡Œé¢æ‡‰ç”¨æ§‹å»ºæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### æ§‹å»ºçµæžœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # æª¢æŸ¥å„å¹³å°æ§‹å»ºç‹€æ…‹
        if [ "${{ needs.build-desktop.result }}" = "success" ]; then
          echo "âœ… æ‰€æœ‰å¹³å°æ§‹å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.build-desktop.result }}" = "failure" ]; then
          echo "âŒ éƒ¨åˆ†å¹³å°æ§‹å»ºå¤±æ•—" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ æ§‹å»ºç‹€æ…‹: ${{ needs.build-desktop.result }}" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ä¸‹ä¸€æ­¥" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- æ§‹å»ºç”¢ç‰©å·²ä¸Šå‚³åˆ° GitHub Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "- å¯ä»¥åœ¨ç™¼ä½ˆæµç¨‹ä¸­ä½¿ç”¨é€™äº›äºŒé€²åˆ¶æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        echo "- å¦‚éœ€é‡æ–°æ§‹å»ºï¼Œè«‹æ‰‹å‹•è§¸ç™¼æ­¤å·¥ä½œæµç¨‹" >> $GITHUB_STEP_SUMMARY
