name: Auto Release to PyPI

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type (ignored if custom_version is provided)'
        required: false
        default: 'patch'
        type: choice
        options:
        - patch    # 2.0.0 -> 2.0.1 (bug fixes, security patches, documentation updates)
        - minor    # 2.0.0 -> 2.1.0 (new features, enhancements, backward-compatible changes)
        - major    # 2.0.0 -> 3.0.0 (breaking changes, architecture refactoring, API changes)
      custom_version:
        description: 'Custom version number (e.g., 2.5.0) - overrides version_type if provided'
        required: false
        type: string
      include_desktop:
        description: 'æ˜¯å¦åŒ…å«æ¡Œé¢æ‡‰ç”¨äºŒé€²åˆ¶æ–‡ä»¶'
        required: true
        default: true
        type: boolean
      desktop_build_run_id:
        description: 'æ¡Œé¢æ‡‰ç”¨æ§‹å»ºçš„ Run IDï¼ˆå¯é¸ï¼Œç•™ç©ºä½¿ç”¨æœ€æ–°çš„æˆåŠŸæ§‹å»ºï¼‰'
        required: false
        type: string

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"

    - name: Set up Python
      run: uv python install

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Install dependencies
      run: |
        uv sync --dev

    - name: Configure Git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

    - name: Commit dependency changes if any
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          git add .
          git commit -m "ğŸ“¦ Update dependencies" || true
        fi

    - name: Get current version
      id: current_version
      run: |
        CURRENT_VERSION=$(grep '^version =' pyproject.toml | cut -d'"' -f2)
        echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT
        echo "Current version: $CURRENT_VERSION"

    - name: Determine new version
      id: bump_version
      run: |
        CUSTOM_VERSION="${{ github.event.inputs.custom_version }}"

        if [ -n "$CUSTOM_VERSION" ]; then
          echo "ğŸ¯ Using custom version: $CUSTOM_VERSION"

          # Validate version format (basic semver check)
          if [[ ! "$CUSTOM_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Error: Custom version must be in format X.Y.Z (e.g., 2.5.0)"
            exit 1
          fi

          # Update version in pyproject.toml
          sed -i "s/^version = \".*\"/version = \"$CUSTOM_VERSION\"/" pyproject.toml

          # Update version in .bumpversion.cfg
          sed -i "s/^current_version = .*/current_version = $CUSTOM_VERSION/" .bumpversion.cfg

          NEW_VERSION="$CUSTOM_VERSION"
          echo "âœ… Set custom version: $NEW_VERSION"
        else
          echo "ğŸ”„ Using automatic version bump: ${{ github.event.inputs.version_type }}"
          uv run bump2version --allow-dirty ${{ github.event.inputs.version_type }}
          NEW_VERSION=$(grep '^version =' pyproject.toml | cut -d'"' -f2)
          echo "âœ… Bumped version to: $NEW_VERSION"
        fi

        echo "new=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "New version: $NEW_VERSION"

    - name: Update __init__.py version
      run: |
        NEW_VERSION="${{ steps.bump_version.outputs.new }}"
        sed -i "s/__version__ = \".*\"/__version__ = \"$NEW_VERSION\"/" src/mcp_feedback_enhanced/__init__.py

    - name: Extract Release Highlights
      id: extract_highlights
      run: |
        NEW_VERSION="v${{ steps.bump_version.outputs.new }}"

        # Extract highlights from English CHANGELOG
        if [ -f "RELEASE_NOTES/CHANGELOG.en.md" ]; then
          echo "ğŸ” Extracting highlights for $NEW_VERSION from CHANGELOG..."

          # Step 1: Find the version section and extract everything until next version
          sed -n "/## \[${NEW_VERSION}\]/,/## \[/p" RELEASE_NOTES/CHANGELOG.en.md | head -n -1 > version_section.txt

          # Step 2: Try to extract highlights section
          if grep -q "### ğŸŒŸ Highlights" version_section.txt; then
            echo "ğŸ“ Found Highlights section"
            sed -n '/### ğŸŒŸ Highlights/,/### /p' version_section.txt | head -n -1 | tail -n +2 | grep -E "^[^#]" | head -5 > highlights.txt
          elif grep -q "### âœ¨ New Features" version_section.txt; then
            echo "ğŸ“ Using New Features section as highlights"
            sed -n '/### âœ¨ New Features/,/### /p' version_section.txt | head -n -1 | tail -n +2 | grep -E "^- " | head -4 > highlights.txt
          else
            echo "âš ï¸ No highlights or new features section found"
            echo "" > highlights.txt
          fi

          # Clean up temporary file
          rm -f version_section.txt

          # Check if we got any content
          if [ -s highlights.txt ]; then
            echo "âœ… Successfully extracted highlights for $NEW_VERSION"
            echo "ğŸ“„ Content preview:"
            head -2 highlights.txt
          else
            echo "âš ï¸ No highlights extracted, using default content"
            echo "- ğŸš€ New features and improvements" > highlights.txt
            echo "- ğŸ› Bug fixes and optimizations" >> highlights.txt
          fi
        else
          echo "âš ï¸ CHANGELOG.en.md not found, using default highlights"
          echo "- ğŸš€ New features and improvements" > highlights.txt
          echo "- ğŸ› Bug fixes and optimizations" >> highlights.txt
        fi

    - name: Generate Release Body
      id: release_body
      run: |
        NEW_VERSION="v${{ steps.bump_version.outputs.new }}"

        # Get release title from English CHANGELOG
        if [ -f "RELEASE_NOTES/CHANGELOG.en.md" ]; then
          RELEASE_TITLE=$(grep "## \[${NEW_VERSION}\]" RELEASE_NOTES/CHANGELOG.en.md | head -1 | sed 's/## \[.*\] - //')
        fi
        if [ -z "$RELEASE_TITLE" ]; then
          RELEASE_TITLE="Latest Release"
        fi

        # Create release body header
        echo "# Release ${NEW_VERSION} - ${RELEASE_TITLE}" > release_body.md
        echo "" >> release_body.md
        echo "## ğŸŒŸ Key Highlights" >> release_body.md

        # Add highlights
        if [ -s highlights.txt ]; then
          cat highlights.txt >> release_body.md
        else
          echo "- ğŸš€ New features and improvements" >> release_body.md
          echo "- ğŸ› Bug fixes and optimizations" >> release_body.md
        fi

        # Add multi-language links section
        echo "" >> release_body.md
        echo "## ğŸŒ Detailed Release Notes" >> release_body.md
        echo "" >> release_body.md
        echo "### ğŸ‡ºğŸ‡¸ English" >> release_body.md
        echo "ğŸ“– **[View Complete English Release Notes](https://github.com/Minidoracat/mcp-feedback-enhanced/blob/main/RELEASE_NOTES/CHANGELOG.en.md)**" >> release_body.md
        echo "" >> release_body.md
        echo "### ğŸ‡¹ğŸ‡¼ ç¹é«”ä¸­æ–‡" >> release_body.md
        echo "ğŸ“– **[æŸ¥çœ‹å®Œæ•´ç¹é«”ä¸­æ–‡ç™¼å¸ƒèªªæ˜](https://github.com/Minidoracat/mcp-feedback-enhanced/blob/main/RELEASE_NOTES/CHANGELOG.zh-TW.md)**" >> release_body.md
        echo "" >> release_body.md
        echo "### ğŸ‡¨ğŸ‡³ ç®€ä½“ä¸­æ–‡" >> release_body.md
        echo "ğŸ“– **[æŸ¥çœ‹å®Œæ•´ç®€ä½“ä¸­æ–‡å‘å¸ƒè¯´æ˜](https://github.com/Minidoracat/mcp-feedback-enhanced/blob/main/RELEASE_NOTES/CHANGELOG.zh-CN.md)**" >> release_body.md
        echo "" >> release_body.md
        echo "---" >> release_body.md
        echo "" >> release_body.md
        echo "## ğŸ“¦ Quick Installation / å¿«é€Ÿå®‰è£" >> release_body.md
        echo "" >> release_body.md
        echo '```bash' >> release_body.md
        echo "# Latest version / æœ€æ–°ç‰ˆæœ¬" >> release_body.md
        echo "uvx mcp-feedback-enhanced@latest" >> release_body.md
        echo "" >> release_body.md
        echo "# This specific version / æ­¤ç‰¹å®šç‰ˆæœ¬" >> release_body.md
        echo "uvx mcp-feedback-enhanced@${NEW_VERSION}" >> release_body.md
        echo '```' >> release_body.md
        echo "" >> release_body.md
        echo "## ğŸ”— Links" >> release_body.md
        echo "- **Documentation**: [README.md](https://github.com/Minidoracat/mcp-feedback-enhanced/blob/main/README.md)" >> release_body.md
        echo "- **Full Changelog**: [CHANGELOG](https://github.com/Minidoracat/mcp-feedback-enhanced/blob/main/RELEASE_NOTES/)" >> release_body.md
        echo "- **Issues**: [GitHub Issues](https://github.com/Minidoracat/mcp-feedback-enhanced/issues)" >> release_body.md
        echo "" >> release_body.md
        echo "---" >> release_body.md
        echo "**Release automatically generated from CHANGELOG system** ğŸ¤–" >> release_body.md

        echo "Release body generated successfully"

    - name: Verify CHANGELOG Files
      run: |
        NEW_VERSION="v${{ steps.bump_version.outputs.new }}"

        # Check if CHANGELOG files exist and contain the new version
        echo "ğŸ” Verifying CHANGELOG files contain version ${NEW_VERSION}..."

        MISSING_FILES=""

        if [ -f "RELEASE_NOTES/CHANGELOG.en.md" ]; then
          if ! grep -q "\[${NEW_VERSION}\]" "RELEASE_NOTES/CHANGELOG.en.md"; then
            echo "âš ï¸ Warning: ${NEW_VERSION} not found in CHANGELOG.en.md"
            MISSING_FILES="${MISSING_FILES} en"
          else
            echo "âœ… Found ${NEW_VERSION} in CHANGELOG.en.md"
          fi
        else
          echo "âŒ CHANGELOG.en.md not found"
          MISSING_FILES="${MISSING_FILES} en"
        fi

        if [ -f "RELEASE_NOTES/CHANGELOG.zh-TW.md" ]; then
          if ! grep -q "\[${NEW_VERSION}\]" "RELEASE_NOTES/CHANGELOG.zh-TW.md"; then
            echo "âš ï¸ Warning: ${NEW_VERSION} not found in CHANGELOG.zh-TW.md"
            MISSING_FILES="${MISSING_FILES} zh-TW"
          else
            echo "âœ… Found ${NEW_VERSION} in CHANGELOG.zh-TW.md"
          fi
        else
          echo "âŒ CHANGELOG.zh-TW.md not found"
          MISSING_FILES="${MISSING_FILES} zh-TW"
        fi

        if [ -f "RELEASE_NOTES/CHANGELOG.zh-CN.md" ]; then
          if ! grep -q "\[${NEW_VERSION}\]" "RELEASE_NOTES/CHANGELOG.zh-CN.md"; then
            echo "âš ï¸ Warning: ${NEW_VERSION} not found in CHANGELOG.zh-CN.md"
            MISSING_FILES="${MISSING_FILES} zh-CN"
          else
            echo "âœ… Found ${NEW_VERSION} in CHANGELOG.zh-CN.md"
          fi
        else
          echo "âŒ CHANGELOG.zh-CN.md not found"
          MISSING_FILES="${MISSING_FILES} zh-CN"
        fi

        if [ -n "$MISSING_FILES" ]; then
          echo ""
          echo "ğŸ“ Note: Please ensure CHANGELOG files are updated with version ${NEW_VERSION}"
          echo "Missing or incomplete files:${MISSING_FILES}"
          echo "The release will continue, but manual CHANGELOG updates may be needed."
        else
          echo "âœ… All CHANGELOG files verified successfully"
        fi

    - name: Commit version bump
      run: |
        CUSTOM_VERSION="${{ github.event.inputs.custom_version }}"
        VERSION_METHOD=""

        if [ -n "$CUSTOM_VERSION" ]; then
          VERSION_METHOD="Custom version specified: $CUSTOM_VERSION"
        else
          VERSION_METHOD="Auto-bumped (${{ github.event.inputs.version_type }})"
        fi

        git add .
        git commit -m "ğŸ”– Release v${{ steps.bump_version.outputs.new }}

        - Updated version to ${{ steps.bump_version.outputs.new }}
        - $VERSION_METHOD
        - Auto-generated release from workflow"
        git tag "v${{ steps.bump_version.outputs.new }}"

    - name: Download desktop binaries from latest build
      if: ${{ github.event.inputs.include_desktop == 'true' }}
      uses: dawidd6/action-download-artifact@v6
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        workflow: build-desktop.yml
        run_id: ${{ github.event.inputs.desktop_build_run_id }}
        path: desktop-artifacts
        if_no_artifact_found: warn

    - name: Prepare multi-platform desktop binaries
      if: ${{ github.event.inputs.include_desktop == 'true' }}
      run: |
        # æª¢æŸ¥æ˜¯å¦æœ‰æ¡Œé¢æ‡‰ç”¨æ§‹å»ºç”¢ç‰©
        if [ ! -d "desktop-artifacts" ] || [ -z "$(ls -A desktop-artifacts 2>/dev/null)" ]; then
          echo "âš ï¸ è­¦å‘Šï¼šæ²’æœ‰æ‰¾åˆ°æ¡Œé¢æ‡‰ç”¨æ§‹å»ºç”¢ç‰©"
          echo "ğŸ’¡ æç¤ºï¼šè«‹å…ˆé‹è¡Œ 'Build Desktop Applications' å·¥ä½œæµç¨‹"
          echo "ğŸ”§ æˆ–è€…è¨­ç½® include_desktop ç‚º false ä¾†è·³éæ¡Œé¢æ‡‰ç”¨"
          exit 1
        fi

        # å‰µå»ºæ¡Œé¢æ‡‰ç”¨ç›®éŒ„
        mkdir -p src/mcp_feedback_enhanced/desktop_release

        # è¤‡è£½æ‰€æœ‰å¹³å°çš„äºŒé€²åˆ¶æ–‡ä»¶ä¸¦é‡å‘½å
        echo "ğŸ“¦ æº–å‚™å¤šå¹³å°æ¡Œé¢æ‡‰ç”¨äºŒé€²åˆ¶æ–‡ä»¶..."

        # æª¢æŸ¥ä¸¦è¤‡è£½å„å¹³å°æ–‡ä»¶
        if [ -f "desktop-artifacts/desktop-windows/mcp-feedback-enhanced-desktop.exe" ]; then
          cp desktop-artifacts/desktop-windows/mcp-feedback-enhanced-desktop.exe src/mcp_feedback_enhanced/desktop_release/
          echo "âœ… Windows äºŒé€²åˆ¶æ–‡ä»¶å·²è¤‡è£½"
        else
          echo "âš ï¸ Windows äºŒé€²åˆ¶æ–‡ä»¶ä¸å­˜åœ¨"
        fi

        if [ -f "desktop-artifacts/desktop-macos-intel/mcp-feedback-enhanced-desktop" ]; then
          cp desktop-artifacts/desktop-macos-intel/mcp-feedback-enhanced-desktop src/mcp_feedback_enhanced/desktop_release/mcp-feedback-enhanced-desktop-macos-intel
          echo "âœ… macOS Intel äºŒé€²åˆ¶æ–‡ä»¶å·²è¤‡è£½"
        else
          echo "âš ï¸ macOS Intel äºŒé€²åˆ¶æ–‡ä»¶ä¸å­˜åœ¨"
        fi

        if [ -f "desktop-artifacts/desktop-macos-arm64/mcp-feedback-enhanced-desktop" ]; then
          cp desktop-artifacts/desktop-macos-arm64/mcp-feedback-enhanced-desktop src/mcp_feedback_enhanced/desktop_release/mcp-feedback-enhanced-desktop-macos-arm64
          echo "âœ… macOS ARM64 äºŒé€²åˆ¶æ–‡ä»¶å·²è¤‡è£½"
        else
          echo "âš ï¸ macOS ARM64 äºŒé€²åˆ¶æ–‡ä»¶ä¸å­˜åœ¨"
        fi

        if [ -f "desktop-artifacts/desktop-linux/mcp-feedback-enhanced-desktop" ]; then
          cp desktop-artifacts/desktop-linux/mcp-feedback-enhanced-desktop src/mcp_feedback_enhanced/desktop_release/mcp-feedback-enhanced-desktop-linux
          echo "âœ… Linux äºŒé€²åˆ¶æ–‡ä»¶å·²è¤‡è£½"
        else
          echo "âš ï¸ Linux äºŒé€²åˆ¶æ–‡ä»¶ä¸å­˜åœ¨"
        fi

        # è¨­ç½®åŸ·è¡Œæ¬Šé™
        chmod +x src/mcp_feedback_enhanced/desktop_release/mcp-feedback-enhanced-desktop-* 2>/dev/null || true

        # å‰µå»º __init__.py
        echo '"""æ¡Œé¢æ‡‰ç”¨ç¨‹å¼äºŒé€²åˆ¶æª”æ¡ˆ"""' > src/mcp_feedback_enhanced/desktop_release/__init__.py

        # é¡¯ç¤ºæ–‡ä»¶åˆ—è¡¨
        echo "ğŸ“¦ æœ€çµ‚çš„æ¡Œé¢æ‡‰ç”¨äºŒé€²åˆ¶æ–‡ä»¶ï¼š"
        ls -la src/mcp_feedback_enhanced/desktop_release/

    - name: Build desktop applications locally (fallback)
      if: ${{ github.event.inputs.include_desktop == 'true' }}
      run: |
        # å¦‚æœæ²’æœ‰é æ§‹å»ºçš„æ¡Œé¢æ‡‰ç”¨ï¼Œå˜—è©¦æœ¬åœ°æ§‹å»º
        if [ ! -d "src/mcp_feedback_enhanced/desktop_release" ] || [ -z "$(ls -A src/mcp_feedback_enhanced/desktop_release 2>/dev/null)" ]; then
          echo "ğŸ”§ æ²’æœ‰æ‰¾åˆ°é æ§‹å»ºçš„æ¡Œé¢æ‡‰ç”¨ï¼Œå˜—è©¦æœ¬åœ°æ§‹å»º..."
          echo "âš ï¸ æ³¨æ„ï¼šæœ¬åœ°æ§‹å»ºå¯èƒ½åªæ”¯æ´ç•¶å‰å¹³å°"

          # å®‰è£ Rustï¼ˆå¦‚æœé‚„æ²’å®‰è£ï¼‰
          if ! command -v cargo &> /dev/null; then
            echo "ğŸ“¦ å®‰è£ Rust..."
            curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
            source ~/.cargo/env
          fi

          # é‹è¡Œæœ¬åœ°æ§‹å»ºè…³æœ¬
          python scripts/build_desktop.py --release

          echo "âœ… æœ¬åœ°æ¡Œé¢æ‡‰ç”¨æ§‹å»ºå®Œæˆ"
        else
          echo "âœ… ä½¿ç”¨é æ§‹å»ºçš„æ¡Œé¢æ‡‰ç”¨"
        fi

    - name: Skip desktop applications
      if: ${{ github.event.inputs.include_desktop != 'true' }}
      run: |
        echo "â­ï¸ è·³éæ¡Œé¢æ‡‰ç”¨ï¼Œåƒ…ç™¼ä½ˆ Web ç‰ˆæœ¬"
        echo "ğŸ’¡ ç”¨æˆ¶å°‡åªèƒ½ä½¿ç”¨ Web æ¨¡å¼ï¼Œç„¡æ³•ä½¿ç”¨æ¡Œé¢æ¨¡å¼"

    - name: Build package
      run: uv build

    - name: Check package
      run: uv run twine check dist/*

    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        user: __token__
        password: ${{ secrets.PYPI_API_TOKEN }}

    - name: Push changes and tags
      run: |
        git push origin main
        git push origin "v${{ steps.bump_version.outputs.new }}"

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: "v${{ steps.bump_version.outputs.new }}"
        name: "Release v${{ steps.bump_version.outputs.new }}"
        body_path: release_body.md
        draft: false
        prerelease: false
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Summary
      run: |
        echo "ğŸ‰ Release v${{ steps.bump_version.outputs.new }} completed successfully!"
        echo ""
        echo "ğŸ“¦ Published to PyPI: https://pypi.org/project/mcp-feedback-enhanced/"
        echo "ğŸš€ GitHub Release: https://github.com/Minidoracat/mcp-feedback-enhanced/releases/tag/v${{ steps.bump_version.outputs.new }}"
        echo "ğŸ“ Release notes generated from CHANGELOG files"
        echo ""

        # é¡¯ç¤ºæ¡Œé¢æ‡‰ç”¨ç‹€æ…‹
        if [ "${{ github.event.inputs.include_desktop }}" = "true" ]; then
          echo "ğŸ–¥ï¸ æ¡Œé¢æ‡‰ç”¨ç‹€æ…‹ï¼š"
          if [ -d "src/mcp_feedback_enhanced/desktop_release" ] && [ -n "$(ls -A src/mcp_feedback_enhanced/desktop_release 2>/dev/null)" ]; then
            echo "  âœ… æ¡Œé¢æ‡‰ç”¨å·²åŒ…å«åœ¨ç™¼ä½ˆä¸­"
            echo "  ğŸ“± æ”¯æ´çš„å¹³å°ï¼š"
            [ -f "src/mcp_feedback_enhanced/desktop_release/mcp-feedback-enhanced-desktop.exe" ] && echo "    - Windows x64"
            [ -f "src/mcp_feedback_enhanced/desktop_release/mcp-feedback-enhanced-desktop-macos-intel" ] && echo "    - macOS Intel"
            [ -f "src/mcp_feedback_enhanced/desktop_release/mcp-feedback-enhanced-desktop-macos-arm64" ] && echo "    - macOS Apple Silicon"
            [ -f "src/mcp_feedback_enhanced/desktop_release/mcp-feedback-enhanced-desktop-linux" ] && echo "    - Linux x64"
          else
            echo "  âš ï¸ æ¡Œé¢æ‡‰ç”¨æœªåŒ…å«ï¼ˆå¯èƒ½æ§‹å»ºå¤±æ•—ï¼‰"
          fi
        else
          echo "ğŸ–¥ï¸ æ¡Œé¢æ‡‰ç”¨ç‹€æ…‹ï¼šâ­ï¸ å·²è·³éï¼ˆåƒ… Web ç‰ˆæœ¬ï¼‰"
        fi

        echo ""
        echo "âœ… Next steps:"
        echo "  - Check the release on GitHub"
        echo "  - Verify the package on PyPI"
        echo "  - Test installation with: uvx mcp-feedback-enhanced@v${{ steps.bump_version.outputs.new }}"
        if [ "${{ github.event.inputs.include_desktop }}" = "true" ]; then
          echo "  - Test desktop mode with: uvx mcp-feedback-enhanced@v${{ steps.bump_version.outputs.new }} test --desktop"
        fi
        echo ""
        echo "ğŸ“‹ Note: Make sure CHANGELOG files are updated for future releases"
